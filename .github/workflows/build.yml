# Build libslipstream.so for Android ABIs with extra diagnostics
name: Build libslipstream for Android (debug)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/build.yml'
      - 'crates/slipstream-client/**'
      - 'Cargo.lock'
      - 'vendor/**'

env:
  TZ: UTC

jobs:
  build:
    name: Build libslipstream (matrix)
    runs-on: ubuntu-latest
    timeout-minutes: 120

    strategy:
      matrix:
        target:
          - rust_triple: aarch64-linux-android
            ndk_triple: aarch64-linux-android
            abi: arm64-v8a
            api: 33
          - rust_triple: armv7-linux-androideabi
            ndk_triple: armv7a-linux-androideabi
            abi: armeabi-v7a
            api: 33
          - rust_triple: x86_64-linux-android
            ndk_triple: x86_64-linux-android
            abi: x86_64
            api: 33
          - rust_triple: i686-linux-android
            ndk_triple: i686-linux-android
            abi: x86
            api: 33

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true

      - name: Install Rust toolchain and target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target.rust_triple }}

      - name: Print tool versions and targets
        run: |
          echo "=== rustc / cargo versions ==="
          rustc --version --verbose || true
          cargo --version --verbose || true
          echo "=== rustup targets installed ==="
          rustup target list --installed || true
          echo "=== NDK toolchain check ==="
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME"
          NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          CC_PATH="${NDK_TOOLCHAIN}/bin/${{ matrix.target.ndk_triple }}${{ matrix.target.api }}-clang"
          echo "Expected clang: $CC_PATH"
          ls -la "$(dirname "$CC_PATH")" || true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3 perl pkg-config libssl-dev git

      - name: Prepare picoquic vendor (submodule or clone fallback)
        run: |
          ls -la vendor || true
          if [ -f vendor/picoquic/CMakeLists.txt ]; then
            echo "Found vendor/picoquic"
          else
            echo "Attempting to clone picoquic fallback into vendor/picoquic"
            git clone --depth 1 https://github.com/ekr/picoquic.git vendor/picoquic || true
            ls -la vendor/picoquic || true
          fi

      - name: Cache Cargo and target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crates/slipstream-client/target
          key: ${{ runner.os }}-cargo-${{ matrix.target.abi }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup toolchain env for ${{ matrix.target.abi }}
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          CC_PATH="${NDK_TOOLCHAIN}/bin/${{ matrix.target.ndk_triple }}${{ matrix.target.api }}-clang"
          CXX_PATH="${NDK_TOOLCHAIN}/bin/${{ matrix.target.ndk_triple }}${{ matrix.target.api }}-clang++"
          AR_PATH="${NDK_TOOLCHAIN}/bin/llvm-ar"
          RANLIB_PATH="${NDK_TOOLCHAIN}/bin/llvm-ranlib"
          TARGET_UPPER=$(echo "${{ matrix.target.rust_triple }}" | tr '[:lower:]-' '[:upper:]_')
          echo "CARGO_TARGET_${TARGET_UPPER}_LINKER=${CC_PATH}" >> $GITHUB_ENV
          echo "CC=${CC_PATH}" >> $GITHUB_ENV
          echo "CXX=${CXX_PATH}" >> $GITHUB_ENV
          echo "AR=${AR_PATH}" >> $GITHUB_ENV
          echo "RANLIB=${RANLIB_PATH}" >> $GITHUB_ENV
          echo "ANDROID_PLATFORM=android-${{ matrix.target.api }}" >> $GITHUB_ENV
          echo "ANDROID_ABI=${{ matrix.target.abi }}" >> $GITHUB_ENV
          echo "CMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" >> $GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
          echo "OPENSSL_ROOT_DIR=/usr" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=/usr/include" >> $GITHUB_ENV
          echo "OPENSSL_CRYPTO_LIBRARY=/usr/lib/x86_64-linux-gnu/libcrypto.so" >> $GITHUB_ENV
          echo "OPENSSL_SSL_LIBRARY=/usr/lib/x86_64-linux-gnu/libssl.so" >> $GITHUB_ENV

      - name: Verbose build libslipstream (cdylib) for ${{ matrix.target.abi }}
        working-directory: crates/slipstream-client
        run: |
          set -x
          echo "Running cargo build (verbose) for target ${{ matrix.target.rust_triple }}"
          # verbose build so linker / compile errors are printed
          cargo build -v --release --target ${{ matrix.target.rust_triple }} --lib --features openssl-vendored,picoquic-minimal-build

      - name: List crate target tree
        run: |
          echo "Repository root target entries:"
          ls -la target || true
          echo "crate-relative target entries:"
          ls -la crates/slipstream-client/target || true
          echo "Recursive listing under crate target (3 levels):"
          find crates/slipstream-client/target -maxdepth 4 -type d -print -exec ls -la {} \; || true
          echo "Search for libslipstream files:"
          find crates/slipstream-client/target -type f -name "libslipstream.*" -print -exec file {} \; || true

      - name: Ensure built lib exists (searching multiple locations)
        run: |
          TRIPLE=${{ matrix.target.rust_triple }}
          CAND1="crates/slipstream-client/target/${TRIPLE}/release/libslipstream.so"
          CAND2="crates/slipstream-client/target/${TRIPLE}/release/deps/libslipstream.so"
          CAND3="crates/slipstream-client/target/release/libslipstream.so"
          echo "Checking candidates:"
          echo "$CAND1"
          echo "$CAND2"
          echo "$CAND3"
          if [ -f "$CAND1" ]; then
            LIB="$CAND1"
          elif [ -f "$CAND2" ]; then
            LIB="$CAND2"
          elif [ -f "$CAND3" ]; then
            LIB="$CAND3"
          else
            echo "ERROR: no libslipstream.so found. Dumping relevant directories for debugging:"
            ls -la crates/slipstream-client/target/${TRIPLE}/release || true
            ls -la crates/slipstream-client/target/release || true
            find crates/slipstream-client/target -type f -maxdepth 4 -print -exec file {} \; || true
            exit 1
          fi
          echo "Found library: $LIB"
          ls -lh "$LIB"
          file "$LIB"
          file "$LIB" | grep -E "shared object|shared library" || (file "$LIB" && exit 1)
          echo "Setting output var LIB_PATH=$LIB"
          echo "LIB_PATH=$LIB" >> $GITHUB_ENV

      - name: Upload lib artifact (repo-relative path)
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-${{ matrix.target.abi }}
          path: ${{ env.LIB_PATH }}
          retention-days: 7

  package:
    name: Package libs and create zip
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: libs

      - name: Setup Android NDK (for strip)
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true

      - name: Verify downloaded libs
        run: |
          echo "Listing libs:"
          find libs -type f -maxdepth 3 -print -exec file {} \;
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            FILE="libs/slipstream-${abi}/libslipstream.so"
            if [ ! -f "$FILE" ]; then
              echo "ERROR: missing $FILE"
              exit 1
            fi
            echo "=== $abi ==="
            ls -lh "$FILE"
            file "$FILE"
          done

      - name: Strip libraries
        run: |
          STRIP="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            SRC="libs/slipstream-${abi}/libslipstream.so"
            SIZE_BEFORE=$(stat -c%s "$SRC")
            "$STRIP" "$SRC" || echo "strip failed for $SRC"
            SIZE_AFTER=$(stat -c%s "$SRC")
            echo "✓ Stripped ${abi}: $(numfmt --to=iec $SIZE_BEFORE) → $(numfmt --to=iec $SIZE_AFTER)"
          done

      - name: Create zip package (jniLibs layout)
        run: |
          mkdir -p out/jniLibs
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            mkdir -p out/jniLibs/${abi}
            cp libs/slipstream-${abi}/libslipstream.so out/jniLibs/${abi}/libslipstream.so
          done
          cd out
          zip -r ../slipstream-android-jniLibs.zip jniLibs
          cd ..
          sha256sum slipstream-android-jniLibs.zip > slipstream-android-jniLibs.zip.sha256
          ls -lh slipstream-android-jniLibs.zip slipstream-android-jniLibs.zip.sha256

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-android-jniLibs
          path: |
            slipstream-android-jniLibs.zip
            slipstream-android-jniLibs.zip.sha256
          retention-days: 30